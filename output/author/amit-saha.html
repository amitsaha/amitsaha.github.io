<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Programming and Writing about it - Amit Saha</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Programming and Writing about it Atom Feed" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">Programming and Writing about it </a></h1>
                <nav><ul>
                    <li><a href="/pages/about.html">About</a></li>
                    <li><a href="/pages/articles.html">Articles</a></li>
                    <li><a href="/pages/books.html">Books</a></li>
                    <li><a href="/pages/personal-projects.html">Personal Projects</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="/introducing-distributed-tracing-in-your-python-application-via-zipkin.html">Introducing distributed tracing in your Python application via Zipkin</a></h1>
<footer class="post-info">
        <abbr class="published" title="2017-03-28T17:00:00+10:00">
                Published: Tue 28 March 2017
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/amit-saha.html">Amit Saha</a>
        </address>
<p>In <a href="/category/python.html">Python</a>.</p>

</footer><!-- /.post-info --><p>Distributed tracing is the idea of tracing a network request as it travels through your services, as it would be in a microservices based architecture. The primary reason you may want to do is to troubleshoot or monitor the latency of a request
as it travels through the different services.</p>
<p>In this post we will see a demo of how we can introduce distributed tracing into a Python network stack communicating via HTTP.
We have a service <tt class="docutils literal">demo</tt> which is a Flask application, which listens on <tt class="docutils literal">/</tt>. The handler for <tt class="docutils literal">/</tt> calls another service <tt class="docutils literal">service1</tt> via HTTP. We want to be able to see how much time a request spends in each service by introducing distributed tracing. Before we get to the code, let's talk briefly about a few concepts.</p>
<div class="section" id="distributed-tracing-concepts">
<h2>Distributed Tracing concepts</h2>
<p>Roughly, a call to an &quot;external service&quot; starts a <cite>span</cite>. We can have a <cite>span</cite> nested within another span in a tree like fashion. All the spans in the context of a single request would form a <cite>trace</cite>.</p>
<p>Something like the following would perhaps explain it better in the context of our <tt class="docutils literal">demo</tt> and <tt class="docutils literal">service</tt> network application stack:</p>
<pre class="code literal-block">
                &lt;--------------------          Trace       ------------------------------------ &gt;
                                    Start Root Span                        Start a nested span
External Request -&gt; Demo HTTP app       ---&gt;          Service 1 HTTP app        ---&gt;          Process
</pre>
<p>The span that is started from the <tt class="docutils literal">service1</tt> is designated as a child of the <tt class="docutils literal">root span</tt> which was started from the <tt class="docutils literal">demo</tt> application. In the context of Python, we can think of a span as a context manager and one context manager living within another context manager. And all these &quot;contexts&quot; together forming a trace.</p>
<p>From the above it is somewhat clear (or not) that, the start of each span initiates a &quot;timer&quot; which then on the request's way back (or end of the span) is used to calculate the time the span lasted for. So, we need to have some thing (or things) which has to:</p>
<ul class="simple">
<li>Emit these data</li>
<li>Recieve these data</li>
<li>Allow us to collate them together and make it available to us for each trace or request.</li>
</ul>
<p>This brings us to our next section.</p>
</div>
<div class="section" id="zipkin">
<h2>Zipkin</h2>
<p><a class="reference external" href="http://zipkin.io/">zipkin</a> is a distributed tracing system which gives us the last two of the above requirements. How we emit these data from our application (the first point above) is dependent on the language we have written the application in and the distributed tracing system we chose for the last two requirements. In our case, <a class="reference external" href="https://github.com/Yelp/py_zipkin">py_zipkin</a> solves our problem.</p>
<p>First, we will start <tt class="docutils literal">zipkin</tt> with <tt class="docutils literal">elasticsearch</tt> as the backend as <tt class="docutils literal">docker containers</tt>. So, you need to have <tt class="docutils literal">docker</tt> installed. To get the data in <tt class="docutils literal">elasticsearch</tt> persisted, we will first create a <a class="reference external" href="http://echorand.me/data-only-docker-containers.html">data container</a> as follows:</p>
<pre class="code literal-block">
$ docker create --name esdata openzipkin/zipkin-elasticsearch
</pre>
<p>Then, download my code from <a class="reference external" href="https://github.com/amitsaha/python-web-app-recipes/archive/zipkin_python_demo.zip">here</a> and:</p>
<pre class="code literal-block">
$ wget ..
$ unzip ..
$ cd tracing/http_collector
$ ./start_zipkin.sh
..
..
zipkin          | 2017-03-28 03:48:00.936  INFO 9 --- [           main] zipkin.server.ZipkinServer
Started ZipkinServer in 7.36 seconds (JVM running for 8.595)
</pre>
<p>If you now go to <tt class="docutils literal"><span class="pre">http://localhost:9411/</span></tt> in your browser, you will see the Zipkin Web UI.</p>
</div>
<div class="section" id="creating-traces">
<h2>Creating traces</h2>
<p>Now, let's install the two libraries we need from the <tt class="docutils literal">requirements.txt</tt> via <tt class="docutils literal">pip install <span class="pre">-r</span> requirements.txt</tt>.</p>
<p>Let's now start our two services, first the &quot;external&quot; facing demo service:</p>
<pre class="code literal-block">
$ python demo.py

* Running on http://127.0.0.1:5000/ (Press CTRL+C to quit)
* Restarting with stat
* Debugger is active!
* Debugger pin code: 961-605-579
</pre>
<p>Then, the &quot;internal&quot; service 1:</p>
<pre class="code literal-block">
$ python service1.py
* Running on http://127.0.0.1:6000/ (Press CTRL+C to quit)
* Restarting with stat
* Debugger is active!
* Debugger pin code: 961-605-579
</pre>
<p>Now, let's make couple of requests to the <tt class="docutils literal">demo</tt> service using <tt class="docutils literal">$ curl localhost:5000</tt> twice. If we go back to the Zipkin Web UI and click on &quot;Find Traces&quot;, we will see something like this:</p>
<img alt="" class="align-center" src="/images/zipkin-traces.png" />
<p>If we click on one of the traces, we will see something like this:</p>
<img alt="" class="align-center" src="/images/zipkin-trace1.png" />
<p>As we can see four spans were created (two spans in each service) with the 2nd, 3rd and 4th spans nested inside the first span. The time reported to be spent in each span will become clear next.</p>
</div>
<div class="section" id="application-code">
<h2>Application code</h2>
<p>Let's look at the <tt class="docutils literal">demo.py</tt> file first:</p>
<pre class="code literal-block">
&#64;zipkin_span(service_name='webapp', span_name='do_stuff')
def do_stuff():
    time.sleep(5)
    headers = create_http_headers_for_new_span()
    requests.get('http://localhost:6000/service1/', headers=headers)
    return 'OK'

&#64;app.route('/')
def index():
    with zipkin_span(
        service_name='webapp',
        span_name='index',
        transport_handler=http_transport,
        port=5000,
        sample_rate=100, #0.05, # Value between 0.0 and 100.0
    ):
        do_stuff()
        time.sleep(10)
    return 'OK', 200
</pre>
<p>We create the first span inside the <tt class="docutils literal">/</tt> handler function <tt class="docutils literal">index()</tt> via the <tt class="docutils literal">zipkin_span()</tt> context manager.
We specify the <tt class="docutils literal">sample_rate=100</tt> meaning it will trace every request (only for demo). The <tt class="docutils literal">transport_handler</tt>
specifies &quot;how&quot; the emitted traces are transported to the Zipkin &quot;collector&quot;. Here we use the <tt class="docutils literal">http_transport</tt>
provided as example by the <tt class="docutils literal">py_zipkin</tt> project.</p>
<p>This handler function calls the <tt class="docutils literal">do_stuff()</tt> function where we create another span, but since it is in the same
service, we specify the same <tt class="docutils literal">service_name</tt> and decorate it with the <tt class="docutils literal">zipkin_span</tt> decorator. We have an artificial
time delay of 5s before we make a HTTP call to the <tt class="docutils literal">service1</tt> service. Since we want to continue the current span, we
pass in the span data as HTTP headers. These headers are created via the helper function, <tt class="docutils literal">create_http_headers_for_new_span()</tt> provided via <tt class="docutils literal">py_zipkin</tt>.</p>
<p>Let's look at the <tt class="docutils literal">service1.py</tt> file next:</p>
<pre class="code literal-block">
&#64;zipkin_span(service_name='service1', span_name='service1_do_stuff')
def do_stuff():
    time.sleep(5)
    return 'OK'

&#64;app.route('/service1/')
def index():
    with zipkin_span(
        service_name='service1',
        zipkin_attrs=ZipkinAttrs(
            trace_id=request.headers['X-B3-TraceID'],
            span_id=request.headers['X-B3-SpanID'],
            parent_span_id=request.headers['X-B3-ParentSpanID'],
            flags=request.headers['X-B3-Flags'],
            is_sampled=request.headers['X-B3-Sampled'],
        ),
        span_name='index_service1',
        transport_handler=http_transport,
        port=6000,
        sample_rate=100, #0.05, # Value between 0.0 and 100.0
    ):
        do_stuff()
    return 'OK', 200
</pre>
<p>This is almost the same as our <tt class="docutils literal">demo</tt> service above, but note how we set the <tt class="docutils literal">zipkin_attrs</tt> by making using of the
headers we were passed from the <tt class="docutils literal">demo</tt> service aboev. This makes sure that the span of <tt class="docutils literal">service1</tt> is nested within
the span of <tt class="docutils literal">demo</tt>. Note once again, how we introduce artificial delays here once again to make the trace show
the time spent in each service more clearly.</p>
</div>
                </article>
            </aside><!-- /#featured -->
                <section id="content" class="body">
                    <h1>Other articles</h1>
                    <hr />
                    <ol id="posts-list" class="hfeed">

            <li><article class="hentry">
                <header>
                    <h1><a href="/notes-on-using-golang-to-write-gitbackup.html" rel="bookmark"
                           title="Permalink to Notes on using Golang to write gitbackup">Notes on using Golang to write gitbackup</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-03-26T10:00:00+10:00">
                Published: Sun 26 March 2017
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/amit-saha.html">Amit Saha</a>
        </address>
<p>In <a href="/category/golang.html">golang</a>.</p>

</footer><!-- /.post-info -->                <p><a class="reference external" href="https://github.com/amitsaha/gitbackup">gitbackup</a> is a tool to backup your git repositories from GitHub and GitLab. I wrote the <a class="reference external" href="https://github.com/amitsaha/gitbackup/releases/tag/lj-0.1">initial version</a> as a project for a golang article which is in review for publication in a Linux magazine. It supports GitHub enterprise installations and custom GitLab installations in addition to repositories on github …</p>
                <a class="readmore" href="/notes-on-using-golang-to-write-gitbackup.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="/queuelogger-and-python-json-logger.html" rel="bookmark"
                           title="Permalink to QueueLogger and Python JSON Logger">QueueLogger and Python JSON Logger</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-03-01T18:00:00+10:00">
                Published: Wed 01 March 2017
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/amit-saha.html">Amit Saha</a>
        </address>
<p>In <a href="/category/python.html">Python</a>.</p>

</footer><!-- /.post-info -->                <div class="section" id="using-queuelogger-with-python-json-logger">
<h2>Using QueueLogger with Python JSON Logger</h2>
<p>When logging from multiple processes (via <tt class="docutils literal">multiprocessing</tt> module),  using <a class="reference external" href="https://pythonhosted.org/logutils/queue.html#logutils.queue.QueueHandler">QueueHandler</a> is one  approach with Python 2.</p>
<p><tt class="docutils literal">QueueHandler</tt> however sets <tt class="docutils literal">exc_info</tt> attribute of a <a class="reference external" href="https://docs.python.org/2/library/logging.html#logging.LogRecord">LogRecord</a>
to <tt class="docutils literal">None</tt> since it is not &quot;pickleable&quot; (more on this later). This becomes a problem when you use <a class="reference external" href="https://github.com/madzak/python-json-logger/">python-json-logger</a> to …</p></div>
                <a class="readmore" href="/queuelogger-and-python-json-logger.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="/setup-golang-18-and-gb-on-fedora-and-other-linux-distributions.html" rel="bookmark"
                           title="Permalink to Setup Golang 1.8 and gb on Fedora (and other Linux distributions)">Setup Golang 1.8 and gb on Fedora (and other Linux distributions)</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2017-03-01T18:00:00+10:00">
                Published: Wed 01 March 2017
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/amit-saha.html">Amit Saha</a>
        </address>
<p>In <a href="/category/golang.html">golang</a>.</p>

</footer><!-- /.post-info -->                <p>This guide will be how I usually setup and get started with Go development environment on Linux. By the end of this document, we will have seen how to:</p>
<ul class="simple">
<li>Install the Go 1.8 compiler and other tools (<tt class="docutils literal">gofmt</tt>, for eaxmple), collectively referred to as go tools</li>
<li>Install <a class="reference external" href="http://getgb.io">gb</a> and …</li></ul>
                <a class="readmore" href="/setup-golang-18-and-gb-on-fedora-and-other-linux-distributions.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="/setup-golang-on-fedora-24-and-other-linux-distributions.html" rel="bookmark"
                           title="Permalink to Setup Golang on Fedora 24 (and other Linux distributions)">Setup Golang on Fedora 24 (and other Linux distributions)</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2016-06-23T18:00:00+10:00">
                Published: Thu 23 June 2016
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/amit-saha.html">Amit Saha</a>
        </address>
<p>In <a href="/category/golang.html">golang</a>.</p>

</footer><!-- /.post-info -->                <p>This guide will be how I usually setup and get started with Go development environment on Linux. By the end of this document, we will have seen how to:</p>
<ul class="simple">
<li>Install the Go compiler and other tools (<tt class="docutils literal">gofmt</tt>, for eaxmple), collectively referred to as go tools</li>
<li>Setup Go workspace</li>
<li>Working with …</li></ul>
                <a class="readmore" href="/setup-golang-on-fedora-24-and-other-linux-distributions.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="/presentation-slides-with-jupyter-notebook.html" rel="bookmark"
                           title="Permalink to Presentation slides with Jupyter Notebook">Presentation slides with Jupyter Notebook</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2016-05-31T22:00:00+10:00">
                Published: Tue 31 May 2016
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/amit-saha.html">Amit Saha</a>
        </address>
<p>In <a href="/category/python.html">Python</a>.</p>

</footer><!-- /.post-info -->                <p>I presented at the PyCon 2016 Education Summit on &quot;Doing Math with Python&quot; day before yesterday and a lightning talk yesterday. This is the first time, I prepared a <a class="reference external" href="doingmathwithpython.github.io/pycon-us-2016">slide deck</a> using Jupyter Notebook + Reveal.js. I was pleased with the content creation process and the end result. So, here …</p>
                <a class="readmore" href="/presentation-slides-with-jupyter-notebook.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="/new-article-write-a-program-to-tee-output-using-rust.html" rel="bookmark"
                           title="Permalink to New article: Write a program to tee output using Rust">New article: Write a program to tee output using Rust</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2016-05-04T14:00:00+10:00">
                Published: Wed 04 May 2016
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/amit-saha.html">Amit Saha</a>
        </address>
<p>In <a href="/category/rust.html">Rust</a>.</p>

</footer><!-- /.post-info -->                <p>My article &quot;Write a program to tee output using Rust&quot; is out in <a class="reference external" href="https://linuxvoice.com">Linux
Voice</a> (Issue 27).</p>
<p>When I first set out to learning Rust, I really liked how the Rust programming language book
took the approach of introducing the language via <a class="reference external" href="https://doc.rust-lang.org/stable/book/guessing-game.html">small projects</a>. In a recent &quot;New Rustacean&quot; <a class="reference external" href="http://www.newrustacean.com/show_notes/bonus/_4/index.html">bonus …</a></p>
                <a class="readmore" href="/new-article-write-a-program-to-tee-output-using-rust.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="/runc-and-libcontainer-on-fedora-2324.html" rel="bookmark"
                           title="Permalink to runC and libcontainer on Fedora 23/24">runC and libcontainer on Fedora 23/24</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2016-04-27T17:00:00+10:00">
                Published: Wed 27 April 2016
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/amit-saha.html">Amit Saha</a>
        </address>
<p>In <a href="/category/golang.html">golang</a>.</p>

</footer><!-- /.post-info -->                <p>In this post, I will post my notes on how I got <a class="reference external" href="https://github.com/opencontainers/runc/">runC</a> and then using
<cite>libcontainer</cite> on Fedora. The first step is to install <tt class="docutils literal">golang</tt>:</p>
<pre class="code literal-block">
$ sudo dnf -y install golang
$ go version
go version go1.6 linux/amd64
</pre>
<p>We will set GOPATH=~/golang/ and then do the following:</p>
<pre class="code literal-block">
$ mkdir …</pre>
                <a class="readmore" href="/runc-and-libcontainer-on-fedora-2324.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="/webucator-video-python-classes-basics-beyond-the-absolute-basics.html" rel="bookmark"
                           title="Permalink to Webucator video: Python classes - basics beyond the absolute basics">Webucator video: Python classes - basics beyond the absolute basics</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2016-04-17T14:00:00+10:00">
                Published: Sun 17 April 2016
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/amit-saha.html">Amit Saha</a>
        </address>
<p>In <a href="/category/python.html">Python</a>.</p>

</footer><!-- /.post-info -->                <p><a class="reference external" href="https://www.webucator.com/">Webucator</a> recently created a video based on my <a class="reference external" href="http://echorand.me/site/notes/articles/python_custom_class/article.html">Python classes: basics beyond the absolute basics</a> article.</p>
<p>You can see the video on <a class="reference external" href="https://www.youtube.com/watch?v=0slsoyEhz40&amp;feature=youtu.be">YouTube</a>  or here below:</p>
<div class="youtube youtube-16x9"><iframe src="https://www.youtube.com/embed/0slsoyEhz40" allowfullscreen seamless frameBorder="0"></iframe></div><p>I think they really did a great job with it and supplements my article well.</p>

                <a class="readmore" href="/webucator-video-python-classes-basics-beyond-the-absolute-basics.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>

            <li><article class="hentry">
                <header>
                    <h1><a href="/new-article-write-an-image-cropping-program-with-go.html" rel="bookmark"
                           title="Permalink to New article: Write an Image Cropping program with Go">New article: Write an Image Cropping program with Go</a></h1>
                </header>

                <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2016-04-17T10:00:00+10:00">
                Published: Sun 17 April 2016
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/amit-saha.html">Amit Saha</a>
        </address>
<p>In <a href="/category/golang.html">golang</a>.</p>

</footer><!-- /.post-info -->                <p>My article &quot;Write an Image Cropping with Go&quot; is out in <a class="reference external" href="https://linuxvoice.com">Linux Voice</a> (Issue 26). It is my first article to be published in Linux Voice and I am very excited about it.</p>
<p>It is challenging to write an introductory article without being able to explain everything the reader needs …</p>
                <a class="readmore" href="/new-article-write-an-image-cropping-program-with-go.html">read more</a>
                </div><!-- /.entry-content -->
            </article></li>
                </ol><!-- /#posts-list -->
<p class="paginator">
    Page 1 / 3
        <a href="/author/amit-saha2.html">&raquo;</a>
</p>
                </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>