<!DOCTYPE html>
<html lang="en">

<head>
  <!-- ## for client-side less
  <link rel="stylesheet/less" type="text/css" href="http://echorand.me/theme/css/style.less">
  <script src="http://cdnjs.cloudflare.com/ajax/libs/less.js/1.7.3/less.min.js" type="text/javascript"></script>
  -->
  <link rel="stylesheet" type="text/css" href="http://echorand.me/theme/css/style.css">
  <link rel="stylesheet" type="text/css" href="http://echorand.me/theme/css/pygments.css">
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Sans|PT+Serif|PT+Mono">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Amit Saha">
  <meta name="description" content="Posts and writings by Amit Saha">

  <link href="http://echorand.me/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Programming and Writing about it Atom" />

<meta name="keywords" content="">

  <title>
    Programming and Writing about it
&ndash; Dissecting golang's HandlerFunc, Handle and DefaultServeMux  </title>

</head>

<body>
  <aside>
    <div id="user_meta">
      <a href="http://echorand.me">
        <img src="http://echorand.me/theme/images/logo.png" alt="logo">
      </a>
      <h2><a href="http://echorand.me">Amit Saha</a></h2>
      <p></p>
      <ul>
        <li><a href="http://echorand.me/pages/about.html">About</a></li>
        <li><a href="http://echorand.me/pages/articles.html">Articles</a></li>
        <li><a href="http://echorand.me/pages/books.html">Books</a></li>
        <li><a href="http://echorand.me/pages/personal-projects.html">Personal Projects</a></li>
      </ul>
    </div>
  </aside>

  <main>
    <header>
      <p>
      <a href="http://echorand.me">Index</a> &brvbar; <a href="http://echorand.me/archives.html">Archives</a>
      &brvbar; <a href="http://echorand.me/feeds/all.atom.xml">Atom</a>
      </p>
    </header>

<article>
  <div class="article_title">
    <h1><a href="http://echorand.me/dissecting-golangs-handlerfunc-handle-and-defaultservemux.html">Dissecting golang's HandlerFunc, Handle and DefaultServeMux</a></h1>
  </div>
  <div class="article_text">
    <p>My aim in this post is to discuss three &quot;concepts&quot; in Golang that I come across while writing HTTP servers. Through this
post, my aim to get rid of my own lack of understanding (at least to a certain degree) about these. Hopefully, it will
be of use to others too. The code references are from <a class="reference external" href="https://golang.org/src/net/http/server.go">src/net/http/server.go</a>.</p>
<p>The <a class="reference external" href="https://golang.org/pkg/net/http/#ListenAndServe">http.ListenAndServe(..)</a> function is the most straightforward
approach to start a HTTP 1.1 server. The following code does just that:</p>
<div class="highlight"><pre><span></span><span class="n">package</span> <span class="n">main</span>

<span class="kn">import</span> <span class="p">(</span>
        <span class="s2">&quot;log&quot;</span>
        <span class="s2">&quot;net/http&quot;</span>
<span class="p">)</span>

<span class="n">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">ListenAndServe</span><span class="p">(</span><span class="s2">&quot;:8080&quot;</span><span class="p">,</span> <span class="n">nil</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>
<p>What is the <cite>nil</cite> second argument above? The documentation states that the second argument to the function should be a
&quot;handler&quot; and if it is specified as <cite>nil</cite>, it defaults to <cite>DefaultServeMux</cite>.</p>
<div class="section" id="what-is-defaultservemux">
<h2>What is <cite>DefaultServeMux</cite>?</h2>
<p>If we run our server above via <tt class="docutils literal">go run server1.go</tt>, and send a couple of HTTP GET requests, we will see the following:</p>
<pre class="code literal-block">
$ curl localhost:8080
404 page not found

$ curl localhost:8080/status/
404 page not found
</pre>
<p>This is because, we haven't specified how our server should handle requests to GET the root (&quot;/&quot;) - our first request or
requests to GET the &quot;/status/&quot; resource - our second request. Before we see how we could fix that, let's understand
<em>how</em> the error message &quot;404 page not found&quot; is generated.</p>
<p>The error message is generated from the function below in <cite>src/net/http/server.go</cite> specifically the <cite>NotFoundHandler()</cite>
&quot;handler&quot; function:</p>
<div class="highlight"><pre><span></span><span class="c1">// handler is the main implementation of Handler.</span>
<span class="c1">// The path is known to be in canonical form, except for CONNECT methods.</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">mux</span> <span class="o">*</span><span class="nx">ServeMux</span><span class="p">)</span> <span class="nx">handler</span><span class="p">(</span><span class="nx">host</span><span class="p">,</span> <span class="nx">path</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">h</span> <span class="nx">Handler</span><span class="p">,</span> <span class="nx">pattern</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">mux</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">RLock</span><span class="p">()</span>
        <span class="k">defer</span> <span class="nx">mux</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">RUnlock</span><span class="p">()</span>

        <span class="c1">// Host-specific pattern takes precedence over generic ones</span>
        <span class="k">if</span> <span class="nx">mux</span><span class="p">.</span><span class="nx">hosts</span> <span class="p">{</span>
                <span class="nx">h</span><span class="p">,</span> <span class="nx">pattern</span> <span class="p">=</span> <span class="nx">mux</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">host</span> <span class="o">+</span> <span class="nx">path</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nx">h</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="nx">h</span><span class="p">,</span> <span class="nx">pattern</span> <span class="p">=</span> <span class="nx">mux</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nx">h</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="nx">h</span><span class="p">,</span> <span class="nx">pattern</span> <span class="p">=</span> <span class="nx">NotFoundHandler</span><span class="p">(),</span> <span class="s">&quot;&quot;</span>
        <span class="p">}</span>
        <span class="k">return</span>
<span class="p">}</span>
</pre></div>
<p>Now, let's roughly see how our GET request above reaches the above function.</p>
<p>Let us consider the function signature of the above handler function: <cite>func (mux *ServeMux) handler(host, path string) (h Handler, pattern string)</cite>. This function is a method belonging to the type <cite>ServeMux</cite>:</p>
<div class="highlight"><pre><span></span><span class="c1">// ServeMux also takes care of sanitizing the URL request path,</span>
<span class="c1">// redirecting any request containing . or .. elements or repeated slashes</span>
<span class="c1">// to an equivalent, cleaner URL.</span>
<span class="kd">type</span> <span class="nx">ServeMux</span> <span class="kd">struct</span> <span class="p">{</span>
        <span class="nx">mu</span>    <span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>
        <span class="nx">m</span>     <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">muxEntry</span>
        <span class="nx">hosts</span> <span class="kt">bool</span> <span class="c1">// whether any patterns contain hostnames</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">muxEntry</span> <span class="kd">struct</span> <span class="p">{</span>
        <span class="nx">explicit</span> <span class="kt">bool</span>
        <span class="nx">h</span>        <span class="nx">Handler</span>
        <span class="nx">pattern</span>  <span class="kt">string</span>
<span class="p">}</span>

<span class="c1">// NewServeMux allocates and returns a new ServeMux.</span>
<span class="kd">func</span> <span class="nx">NewServeMux</span><span class="p">()</span> <span class="o">*</span><span class="nx">ServeMux</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">new</span><span class="p">(</span><span class="nx">ServeMux</span><span class="p">)</span> <span class="p">}</span>

<span class="c1">// DefaultServeMux is the default ServeMux used by Serve.</span>
<span class="kd">var</span> <span class="nx">DefaultServeMux</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">defaultServeMux</span>

<span class="kd">var</span> <span class="nx">defaultServeMux</span> <span class="nx">ServeMux</span>
</pre></div>
<p>So, how does <cite>DefaultServeMux</cite> get set when the second argument to <cite>ListenAndServe()</cite> is <cite>nil</cite>? The following code
snippet has the answer:</p>
<div class="highlight"><pre><span></span><span class="kd">func</span> <span class="p">(</span><span class="nx">sh</span> <span class="nx">serverHandler</span><span class="p">)</span> <span class="nx">ServeHTTP</span><span class="p">(</span><span class="nx">rw</span> <span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">handler</span> <span class="o">:=</span> <span class="nx">sh</span><span class="p">.</span><span class="nx">srv</span><span class="p">.</span><span class="nx">Handler</span>
        <span class="k">if</span> <span class="nx">handler</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="nx">handler</span> <span class="p">=</span> <span class="nx">DefaultServeMux</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nx">req</span><span class="p">.</span><span class="nx">RequestURI</span> <span class="o">==</span> <span class="s">&quot;*&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">Method</span> <span class="o">==</span> <span class="s">&quot;OPTIONS&quot;</span> <span class="p">{</span>
                <span class="nx">handler</span> <span class="p">=</span> <span class="nx">globalOptionsHandler</span><span class="p">{}</span>
        <span class="p">}</span>
        <span class="nx">handler</span><span class="p">.</span><span class="nx">ServeHTTP</span><span class="p">(</span><span class="nx">rw</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
<p>The above call to <cite>ServeHTTP()</cite> calls the following implementation of <cite>ServeHTTP()</cite>:</p>
<div class="highlight"><pre><span></span><span class="c1">// ServeHTTP dispatches the request to the handler whose</span>
<span class="c1">// pattern most closely matches the request URL.</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">mux</span> <span class="o">*</span><span class="nx">ServeMux</span><span class="p">)</span> <span class="nx">ServeHTTP</span><span class="p">(</span><span class="nx">w</span> <span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">RequestURI</span> <span class="o">==</span> <span class="s">&quot;*&quot;</span> <span class="p">{</span>
                <span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">ProtoAtLeast</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">w</span><span class="p">.</span><span class="nx">Header</span><span class="p">().</span><span class="nx">Set</span><span class="p">(</span><span class="s">&quot;Connection&quot;</span><span class="p">,</span> <span class="s">&quot;close&quot;</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="nx">w</span><span class="p">.</span><span class="nx">WriteHeader</span><span class="p">(</span><span class="nx">StatusBadRequest</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="p">}</span>
        <span class="nx">h</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">mux</span><span class="p">.</span><span class="nx">Handler</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
        <span class="nx">h</span><span class="p">.</span><span class="nx">ServeHTTP</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
<p>The call to <cite>Handler()</cite> function then calls the following implementation:</p>
<div class="highlight"><pre><span></span><span class="c1">// If there is no registered handler that applies to the request,</span>
<span class="c1">// Handler returns a ``page not found&#39;&#39; handler and an empty pattern.</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">mux</span> <span class="o">*</span><span class="nx">ServeMux</span><span class="p">)</span> <span class="nx">Handler</span><span class="p">(</span><span class="nx">r</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="nx">h</span> <span class="nx">Handler</span><span class="p">,</span> <span class="nx">pattern</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Method</span> <span class="o">!=</span> <span class="s">&quot;CONNECT&quot;</span> <span class="p">{</span>
                <span class="k">if</span> <span class="nx">p</span> <span class="o">:=</span> <span class="nx">cleanPath</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span><span class="p">);</span> <span class="nx">p</span> <span class="o">!=</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span> <span class="p">{</span>
                        <span class="nx">_</span><span class="p">,</span> <span class="nx">pattern</span> <span class="p">=</span> <span class="nx">mux</span><span class="p">.</span><span class="nx">handler</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Host</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span>
                        <span class="nx">url</span> <span class="o">:=</span> <span class="o">*</span><span class="nx">r</span><span class="p">.</span><span class="nx">URL</span>
                        <span class="nx">url</span><span class="p">.</span><span class="nx">Path</span> <span class="p">=</span> <span class="nx">p</span>
                        <span class="k">return</span> <span class="nx">RedirectHandler</span><span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">String</span><span class="p">(),</span> <span class="nx">StatusMovedPermanently</span><span class="p">),</span> <span class="nx">pattern</span>
                <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">mux</span><span class="p">.</span><span class="nx">handler</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Host</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// handler is the main implementation of Handler.</span>
<span class="c1">// The path is known to be in canonical form, except for CONNECT methods.</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">mux</span> <span class="o">*</span><span class="nx">ServeMux</span><span class="p">)</span> <span class="nx">handler</span><span class="p">(</span><span class="nx">host</span><span class="p">,</span> <span class="nx">path</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">h</span> <span class="nx">Handler</span><span class="p">,</span> <span class="nx">pattern</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">mux</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">RLock</span><span class="p">()</span>
        <span class="k">defer</span> <span class="nx">mux</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">RUnlock</span><span class="p">()</span>

        <span class="c1">// Host-specific pattern takes precedence over generic ones</span>
        <span class="k">if</span> <span class="nx">mux</span><span class="p">.</span><span class="nx">hosts</span> <span class="p">{</span>
                <span class="nx">h</span><span class="p">,</span> <span class="nx">pattern</span> <span class="p">=</span> <span class="nx">mux</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">host</span> <span class="o">+</span> <span class="nx">path</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nx">h</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="nx">h</span><span class="p">,</span> <span class="nx">pattern</span> <span class="p">=</span> <span class="nx">mux</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nx">h</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="nx">h</span><span class="p">,</span> <span class="nx">pattern</span> <span class="p">=</span> <span class="nx">NotFoundHandler</span><span class="p">(),</span> <span class="s">&quot;&quot;</span>
        <span class="p">}</span>
        <span class="k">return</span>
<span class="p">}</span>
</pre></div>
<p>Now, when we make a request to &quot;/&quot; or &quot;/status/&quot;, no match is found by the <cite>mux.match()</cite> call above and hence the
handler returned is the <cite>NotFoundHandler</cite> whose <cite>ServeHTTP()</cite> function is then called to return the &quot;404 page not found&quot;
error message:</p>
<div class="highlight"><pre><span></span><span class="c1">// NotFound replies to the request with an HTTP 404 not found error.</span>
<span class="kd">func</span> <span class="nx">NotFound</span><span class="p">(</span><span class="nx">w</span> <span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span> <span class="nx">Error</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&quot;404 page not found&quot;</span><span class="p">,</span> <span class="nx">StatusNotFound</span><span class="p">)</span> <span class="p">}</span>

<span class="c1">// NotFoundHandler returns a simple request handler</span>
<span class="c1">// that replies to each request with a ``404 page not found&#39;&#39; reply.</span>
<span class="kd">func</span> <span class="nx">NotFoundHandler</span><span class="p">()</span> <span class="nx">Handler</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">HandlerFunc</span><span class="p">(</span><span class="nx">NotFound</span><span class="p">)</span> <span class="p">}</span>
</pre></div>
<p>We will discuss how this &quot;magic&quot; happens in the next section.</p>
</div>
<div class="section" id="registering-handlers">
<h2>Registering handlers</h2>
<p>Let's now update our server code to handle &quot;/&quot; and &quot;/status/&quot;:</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="s">&quot;net/http&quot;</span>
<span class="kn">import</span> <span class="s">&quot;fmt&quot;</span>

<span class="kd">type</span> <span class="nx">mytype</span> <span class="kd">struct</span><span class="p">{}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">mytype</span><span class="p">)</span> <span class="nx">ServeHTTP</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintf</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&quot;Hello there from mytype&quot;</span><span class="p">)</span>
<span class="p">}</span>


<span class="kd">func</span> <span class="nx">StatusHandler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintf</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>

        <span class="nx">t</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">mytype</span><span class="p">)</span>
        <span class="nx">http</span><span class="p">.</span><span class="nx">Handle</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="nx">t</span><span class="p">)</span>

        <span class="nx">http</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">&quot;/status/&quot;</span><span class="p">,</span> <span class="nx">StatusHandler</span><span class="p">)</span>

        <span class="nx">http</span><span class="p">.</span><span class="nx">ListenAndServe</span><span class="p">(</span><span class="s">&quot;:8080&quot;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
<p>If we run the server and send the two requests above, we will see the following responses:</p>
<pre class="code literal-block">
$ curl localhost:8080
Hello there from mytype

$ curl localhost:8080/status/
OK
</pre>
<p>Let's now revisit how the right handler function gets called. In a code snippet above, we saw a call to the <tt class="docutils literal">match()</tt> function which given a path returns the most appropriate registered handler for the path:</p>
<div class="highlight"><pre><span></span><span class="c1">// Find a handler on a handler map given a path string</span>
<span class="c1">// Most-specific (longest) pattern wins</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">mux</span> <span class="o">*</span><span class="nx">ServeMux</span><span class="p">)</span> <span class="nx">match</span><span class="p">(</span><span class="nx">path</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">h</span> <span class="nx">Handler</span><span class="p">,</span> <span class="nx">pattern</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">n</span> <span class="p">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">mux</span><span class="p">.</span><span class="nx">m</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">!</span><span class="nx">pathMatch</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">continue</span>
                <span class="p">}</span>
                <span class="k">if</span> <span class="nx">h</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nb">len</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="p">&gt;</span> <span class="nx">n</span> <span class="p">{</span>
                        <span class="nx">n</span> <span class="p">=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span>
                        <span class="nx">h</span> <span class="p">=</span> <span class="nx">v</span><span class="p">.</span><span class="nx">h</span>
                        <span class="nx">pattern</span> <span class="p">=</span> <span class="nx">v</span><span class="p">.</span><span class="nx">pattern</span>
                <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span>
<span class="p">}</span>
</pre></div>
<p><tt class="docutils literal">mux.m</tt> is a a <tt class="docutils literal">map</tt> data structure defined in the <tt class="docutils literal">ServeMux</tt> structure (snippet earlier in the post) which stores a mapping of a path and the handler we have registered for it.</p>
<p><strong>The HandleFunc() type</strong></p>
<p>Let's go back to the idea of &quot;converting&quot; any function with the signature <tt class="docutils literal">func aFunction(w http.ResponseWriter, r *http.Request)</tt> to the type &quot;HandlerFunc&quot;.</p>
<p>Any type which has a ServeHTTP() method is said to implement the <tt class="docutils literal">Handler</tt> interface:</p>
<pre class="code literal-block">
type HandlerFunc func(ResponseWriter, *Request)

// ServeHTTP calls f(w, req).
func (f HandlerFunc) ServeHTTP(w ResponseWriter, req *Request) {
    f(w, req)
}
</pre>
<p>Going back to the previous version of our server, we see how we do that:</p>
<pre class="code literal-block">
type mytype struct{}

func (t *mytype) ServeHTTP(w http.ResponseWriter, r *http.Request) {
    fmt.Fprintf(w, &quot;Hello there from mytype&quot;)
}
</pre>
<p>The <tt class="docutils literal">ServeHTTP()</tt> method of a Handler is invoked when it has been registered as handling a particular path.</p>
<p>Let's look at what the call to <cite>Handle()</cite> function does:</p>
<div class="highlight"><pre><span></span><span class="c1">// Handle registers the handler for the given pattern</span>
<span class="c1">// in the DefaultServeMux.</span>
<span class="c1">// The documentation for ServeMux explains how patterns are matched.</span>
<span class="kd">func</span> <span class="nx">Handle</span><span class="p">(</span><span class="nx">pattern</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">handler</span> <span class="nx">Handler</span><span class="p">)</span> <span class="p">{</span> <span class="nx">DefaultServeMux</span><span class="p">.</span><span class="nx">Handle</span><span class="p">(</span><span class="nx">pattern</span><span class="p">,</span> <span class="nx">handler</span><span class="p">)</span> <span class="p">}</span>

<span class="c1">// Handle registers the handler for the given pattern.</span>
<span class="c1">// If a handler already exists for pattern, Handle panics.</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">mux</span> <span class="o">*</span><span class="nx">ServeMux</span><span class="p">)</span> <span class="nx">Handle</span><span class="p">(</span><span class="nx">pattern</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">handler</span> <span class="nx">Handler</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">mux</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
        <span class="k">defer</span> <span class="nx">mux</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>

        <span class="k">if</span> <span class="nx">pattern</span> <span class="o">==</span> <span class="s">&quot;&quot;</span> <span class="p">{</span>
                <span class="nb">panic</span><span class="p">(</span><span class="s">&quot;http: invalid pattern &quot;</span> <span class="o">+</span> <span class="nx">pattern</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nx">handler</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="nb">panic</span><span class="p">(</span><span class="s">&quot;http: nil handler&quot;</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nx">mux</span><span class="p">.</span><span class="nx">m</span><span class="p">[</span><span class="nx">pattern</span><span class="p">].</span><span class="nx">explicit</span> <span class="p">{</span>
                <span class="nb">panic</span><span class="p">(</span><span class="s">&quot;http: multiple registrations for &quot;</span> <span class="o">+</span> <span class="nx">pattern</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="nx">mux</span><span class="p">.</span><span class="nx">m</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
                <span class="nx">mux</span><span class="p">.</span><span class="nx">m</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">muxEntry</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="nx">mux</span><span class="p">.</span><span class="nx">m</span><span class="p">[</span><span class="nx">pattern</span><span class="p">]</span> <span class="p">=</span> <span class="nx">muxEntry</span><span class="p">{</span><span class="nx">explicit</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">h</span><span class="p">:</span> <span class="nx">handler</span><span class="p">,</span> <span class="nx">pattern</span><span class="p">:</span> <span class="nx">pattern</span><span class="p">}</span>

        <span class="k">if</span> <span class="nx">pattern</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;/&#39;</span> <span class="p">{</span>
                <span class="nx">mux</span><span class="p">.</span><span class="nx">hosts</span> <span class="p">=</span> <span class="kc">true</span>
        <span class="p">}</span>

        <span class="c1">// Helpful behavior:</span>
        <span class="c1">// If pattern is /tree/, insert an implicit permanent redirect for /tree.</span>
        <span class="c1">// It can be overridden by an explicit registration.</span>
        <span class="nx">n</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">pattern</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">n</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">pattern</span><span class="p">[</span><span class="nx">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">mux</span><span class="p">.</span><span class="nx">m</span><span class="p">[</span><span class="nx">pattern</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nx">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]].</span><span class="nx">explicit</span> <span class="p">{</span>
                <span class="c1">// If pattern contains a host name, strip it and use remaining</span>
                <span class="c1">// path for redirect.</span>
                <span class="nx">path</span> <span class="o">:=</span> <span class="nx">pattern</span>
                <span class="k">if</span> <span class="nx">pattern</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;/&#39;</span> <span class="p">{</span>
                        <span class="c1">// In pattern, at least the last character is a &#39;/&#39;, so</span>
                        <span class="c1">// strings.Index can&#39;t be -1.</span>
                        <span class="nx">path</span> <span class="p">=</span> <span class="nx">pattern</span><span class="p">[</span><span class="nx">strings</span><span class="p">.</span><span class="nx">Index</span><span class="p">(</span><span class="nx">pattern</span><span class="p">,</span> <span class="s">&quot;/&quot;</span><span class="p">):]</span>
                <span class="p">}</span>
                <span class="nx">url</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">url</span><span class="p">.</span><span class="nx">URL</span><span class="p">{</span><span class="nx">Path</span><span class="p">:</span> <span class="nx">path</span><span class="p">}</span>
                <span class="nx">mux</span><span class="p">.</span><span class="nx">m</span><span class="p">[</span><span class="nx">pattern</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nx">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="p">=</span> <span class="nx">muxEntry</span><span class="p">{</span><span class="nx">h</span><span class="p">:</span> <span class="nx">RedirectHandler</span><span class="p">(</span><span class="nx">url</span><span class="p">.</span><span class="nx">String</span><span class="p">(),</span> <span class="nx">StatusMovedPermanently</span><span class="p">),</span> <span class="nx">pattern</span><span class="p">:</span> <span class="nx">pattern</span><span class="p">}</span>
        <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>It can feel cumbersome to define a type implementing the <tt class="docutils literal">Handler</tt> interface for every path we want to register a handler for. Hence, a convenience function, <tt class="docutils literal">HandleFunc()</tt> is provided to register any function which has a specified signature as a Handler function. For example:</p>
<pre class="code literal-block">
http.HandleFunc(&quot;/status/&quot;, StatusHandler)
</pre>
<p>Now, let's look at what the call to <cite>HandleFunc()</cite> function does:</p>
<div class="highlight"><pre><span></span><span class="c1">// HandleFunc registers the handler function for the given pattern</span>
<span class="c1">// in the DefaultServeMux.</span>
<span class="c1">// The documentation for ServeMux explains how patterns are matched.</span>
<span class="kd">func</span> <span class="nx">HandleFunc</span><span class="p">(</span><span class="nx">pattern</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">handler</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="o">*</span><span class="nx">Request</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">DefaultServeMux</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="nx">pattern</span><span class="p">,</span> <span class="nx">handler</span><span class="p">)</span>
<span class="p">}</span>


<span class="c1">// HandleFunc registers the handler function for the given pattern.</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">mux</span> <span class="o">*</span><span class="nx">ServeMux</span><span class="p">)</span> <span class="nx">HandleFunc</span><span class="p">(</span><span class="nx">pattern</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">handler</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="o">*</span><span class="nx">Request</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">mux</span><span class="p">.</span><span class="nx">Handle</span><span class="p">(</span><span class="nx">pattern</span><span class="p">,</span> <span class="nx">HandlerFunc</span><span class="p">(</span><span class="nx">handler</span><span class="p">))</span>
<span class="p">}</span>

<span class="c1">// The HandlerFunc type is an adapter to allow the use of</span>
<span class="c1">// ordinary functions as HTTP handlers.  If f is a function</span>
<span class="c1">// with the appropriate signature, HandlerFunc(f) is a</span>
<span class="c1">// Handler object that calls f.</span>
<span class="kd">type</span> <span class="nx">HandlerFunc</span> <span class="kd">func</span><span class="p">(</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span>

<span class="c1">// ServeHTTP calls f(w, req).</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">f</span> <span class="nx">HandlerFunc</span><span class="p">)</span> <span class="nx">ServeHTTP</span><span class="p">(</span><span class="nx">w</span> <span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">f</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
<p>The call to the <tt class="docutils literal">http.HandleFunc()</tt> function &quot;converts&quot; the provided function to the <tt class="docutils literal">HandleFunc()</tt> type and then calls the <tt class="docutils literal">(mux *ServeMux) Handle()</tt> function similar to what happens when we call the <tt class="docutils literal">Handle()</tt> function. The idea of this conversion is explained in the <a class="reference external" href="https://golang.org/doc/effective_go.html#interface_methods">Effective Go guide</a> and this <a class="reference external" href="http://jordanorelli.com/post/42369331748/function-types-in-go-golang">blog post</a>.</p>
</div>
<div class="section" id="using-your-own-handler-with-listenandserve">
<h2>Using your own Handler with ListenAndServe()</h2>
<p>Earlier in this post, we saw how passsing <tt class="docutils literal">nil</tt> to <tt class="docutils literal">ListenAndServe()</tt> function sets the handler to <tt class="docutils literal">DefaultServeMux</tt>. The handlers
we register via <tt class="docutils literal">Handle()</tt> and <tt class="docutils literal">HandleFunc()</tt> are then added to this object. Hence, we could without changing any functionality rewrite our server as follows:</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="s">&quot;net/http&quot;</span>
<span class="kn">import</span> <span class="s">&quot;fmt&quot;</span>

<span class="kd">type</span> <span class="nx">mytype</span> <span class="kd">struct</span><span class="p">{}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">mytype</span><span class="p">)</span> <span class="nx">ServeHTTP</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintf</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&quot;Hello there from mytype&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">StatusHandler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintf</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>

        <span class="nx">mux</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">NewServeMux</span><span class="p">()</span>

        <span class="nx">t</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">mytype</span><span class="p">)</span>
        <span class="nx">mux</span><span class="p">.</span><span class="nx">Handle</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="nx">t</span><span class="p">)</span>
        <span class="nx">mux</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">&quot;/status/&quot;</span><span class="p">,</span> <span class="nx">StatusHandler</span><span class="p">)</span>

        <span class="nx">http</span><span class="p">.</span><span class="nx">ListenAndServe</span><span class="p">(</span><span class="s">&quot;:8080&quot;</span><span class="p">,</span> <span class="nx">mux</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
<p>We create an object of type <tt class="docutils literal">ServeMux</tt> via <tt class="docutils literal">mux := http.NewServeMux()</tt>, register our handlers calling the same two functions, but those that are defined for the <tt class="docutils literal">ServeMux</tt> object we created.</p>
<p>The reason we may want to use our own Handler with <tt class="docutils literal">ListenAndServe()</tt> is demonstrated in the next section.</p>
</div>
<div class="section" id="writing-middleware">
<h2>Writing Middleware</h2>
<p>In our latest version of the server, we have specified our own handler to <tt class="docutils literal">ListenAndServe()</tt>. One reason for doing so is when you want to execute some code for <em>every</em> request. That is:</p>
<ol class="arabic simple">
<li>Server gets a request for &quot;/path/&quot;</li>
<li>Execute some code</li>
<li>Handler for &quot;/path/&quot; gets called</li>
<li>Execute some code</li>
<li>Return the response to the client</li>
</ol>
<p>Either of steps 2 or 4 or both may occur and this is where &quot;middleware&quot; comes in. Our next version of the server demonstrates how we may implement this:</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="s">&quot;net/http&quot;</span>
<span class="kn">import</span> <span class="s">&quot;fmt&quot;</span>
<span class="kn">import</span> <span class="s">&quot;log&quot;</span>

<span class="kd">type</span> <span class="nx">mytype</span> <span class="kd">struct</span><span class="p">{}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">mytype</span><span class="p">)</span> <span class="nx">ServeHTTP</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintf</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&quot;Hello there from mytype&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">StatusHandler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintf</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">RunSomeCode</span><span class="p">(</span><span class="nx">handler</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span><span class="p">)</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Got a %s request for: %v&quot;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Method</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">)</span>
                <span class="nx">handler</span><span class="p">.</span><span class="nx">ServeHTTP</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
                <span class="c1">// At this stage, our handler has &quot;handled&quot; the request</span>
                <span class="c1">// but we can still write to the client there</span>
                <span class="c1">// but we won&#39;t do that</span>
                <span class="c1">// XXX: We have the HTTP status here, but we cannot access</span>
                <span class="c1">// it directly here</span>
                <span class="c1">// See next example (server5.go)</span>
                <span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Handler finished processing request&quot;</span><span class="p">)</span>
        <span class="p">})</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>

        <span class="nx">mux</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">NewServeMux</span><span class="p">()</span>

        <span class="nx">t</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">mytype</span><span class="p">)</span>
        <span class="nx">mux</span><span class="p">.</span><span class="nx">Handle</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="nx">t</span><span class="p">)</span>
        <span class="nx">mux</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">&quot;/status/&quot;</span><span class="p">,</span> <span class="nx">StatusHandler</span><span class="p">)</span>

        <span class="nx">WrappedMux</span> <span class="o">:=</span> <span class="nx">RunSomeCode</span><span class="p">(</span><span class="nx">mux</span><span class="p">)</span>
        <span class="nx">http</span><span class="p">.</span><span class="nx">ListenAndServe</span><span class="p">(</span><span class="s">&quot;:8080&quot;</span><span class="p">,</span> <span class="nx">WrappedMux</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
<p>When we run the server and send it a couple of requests as above, we will see:</p>
<pre class="code literal-block">
2017/04/24 17:53:03 Got a GET request for: /
2017/04/24 17:53:03 Handler finished processing request
2017/04/24 17:53:05 Got a GET request for: /status
2017/04/24 17:53:05 Handler finished processing request
</pre>
<p>What we are doing above is we are &quot;wrapping&quot; our actual handler in another function <tt class="docutils literal">RunSomeCode(handler http.Handler) http.Handler</tt> which satisfies the <tt class="docutils literal">Handler</tt> interface. In this function, we print a log message, then call the <tt class="docutils literal">ServeHTTP()</tt> method of our original
handler, <tt class="docutils literal">mux</tt>. Once it returns from there, we are then printing another log message.</p>
<p>As part of this middleware writing exercise, I also wanted to be able to print the HTTP status of the response that we are sending but as the comment in the code states, there is no direct way to get the status via the <tt class="docutils literal">ResponseWriter</tt> object. Our next server example will fix this.</p>
</div>
<div class="section" id="rewrapping-http-responsewriter">
<h2>Rewrapping <tt class="docutils literal">http.ResponseWriter</tt></h2>
<p>It took me a while to write the next version of the server, and after reading through some mailing list postings and example code,
i have a version which achieves what I wanted to be able to do via my middleware:</p>
<div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nx">main</span>

<span class="kn">import</span> <span class="s">&quot;net/http&quot;</span>
<span class="kn">import</span> <span class="s">&quot;fmt&quot;</span>
<span class="kn">import</span> <span class="s">&quot;log&quot;</span>

<span class="kd">type</span> <span class="nx">MyResponseWriter</span> <span class="kd">struct</span> <span class="p">{</span>
        <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span>
        <span class="nx">code</span> <span class="kt">int</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">mw</span> <span class="o">*</span><span class="nx">MyResponseWriter</span><span class="p">)</span> <span class="nx">Header</span><span class="p">()</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Header</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">mw</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">.</span><span class="nx">Header</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">mw</span> <span class="o">*</span><span class="nx">MyResponseWriter</span><span class="p">)</span> <span class="nx">WriteHeader</span><span class="p">(</span><span class="nx">code</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">mw</span><span class="p">.</span><span class="nx">code</span> <span class="p">=</span> <span class="nx">code</span>
        <span class="nx">mw</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">.</span><span class="nx">WriteHeader</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">mytype</span> <span class="kd">struct</span><span class="p">{}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">mytype</span><span class="p">)</span> <span class="nx">ServeHTTP</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">w</span><span class="p">.</span><span class="nx">WriteHeader</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">)</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintf</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&quot;Hello there from mytype&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">StatusHandler</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">w</span><span class="p">.</span><span class="nx">WriteHeader</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">)</span>
        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintf</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">RunSomeCode</span><span class="p">(</span><span class="nx">handler</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span><span class="p">)</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Got a %s request for: %v&quot;</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">Method</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">URL</span><span class="p">)</span>
                <span class="nx">myrw</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">MyResponseWriter</span><span class="p">{</span><span class="nx">ResponseWriter</span><span class="p">:</span> <span class="nx">w</span><span class="p">,</span> <span class="nx">code</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span>
                <span class="nx">handler</span><span class="p">.</span><span class="nx">ServeHTTP</span><span class="p">(</span><span class="nx">myrw</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
                <span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Response status: &quot;</span><span class="p">,</span> <span class="nx">myrw</span><span class="p">.</span><span class="nx">code</span><span class="p">)</span>
        <span class="p">})</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>

        <span class="nx">mux</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">NewServeMux</span><span class="p">()</span>

        <span class="nx">t</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">mytype</span><span class="p">)</span>
        <span class="nx">mux</span><span class="p">.</span><span class="nx">Handle</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="nx">t</span><span class="p">)</span>
        <span class="nx">mux</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">&quot;/status/&quot;</span><span class="p">,</span> <span class="nx">StatusHandler</span><span class="p">)</span>

        <span class="nx">WrappedMux</span> <span class="o">:=</span> <span class="nx">RunSomeCode</span><span class="p">(</span><span class="nx">mux</span><span class="p">)</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">ListenAndServe</span><span class="p">(</span><span class="s">&quot;:8080&quot;</span><span class="p">,</span> <span class="nx">WrappedMux</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>
<p>In the example above, I define a new type <tt class="docutils literal">MyResponseWriter</tt> which implements the <tt class="docutils literal">http.ResponseWriter</tt> interface by implementing the
three methods <tt class="docutils literal">Header()</tt>, <tt class="docutils literal">Write()</tt> and <tt class="docutils literal">WriteHeader()</tt>. In bothe <tt class="docutils literal">Write()</tt> and <tt class="docutils literal">WriteHeader()</tt>, I have some custom code that I execute before calling the corresponding method defined on the <tt class="docutils literal">http.ResponseWriter()</tt> interface.</p>
<p>Then, in <tt class="docutils literal">RunSomeCode()</tt>, instead of using the standard <tt class="docutils literal">http.ResponseWriter()</tt> object that it was passed, I wrap it in a <tt class="docutils literal">MyResponseWriter</tt> type as follows:</p>
<pre class="code literal-block">
myrw := &amp;MyResponseWriter{ResponseWriter: w, code: -1}
handler.ServeHTTP(myrw, r)
</pre>
<p>Now, if we run the server, we will see log messages on the server as follows when we send it HTTP get requests:</p>
<pre class="code literal-block">
2017/04/25 17:33:06 Got a GET request for: /status/
2017/04/25 17:33:06 Response status:  200
2017/04/25 17:33:07 Got a GET request for: /status
2017/04/25 17:33:07 Response status:  301
2017/04/25 17:33:10 Got a GET request for: /
2017/04/25 17:33:10 Response status:  200
</pre>
<p>I will end this post with a question and perhaps the possible explanation:</p>
<p>As I write above, it took me a while to figure out how to wrap <tt class="docutils literal">http.ResponseWriter</tt> correctly so that I could get access
to the HTTP status that was being set. The solution that was discussed in <a class="reference external" href="http://grokbase.com/t/gg/golang-nuts/12art4wedc/go-nuts-how-do-i-get-http-status-from-my-own-servehttp-function">this post</a> to just implement the <tt class="docutils literal">WriteHeader()</tt> method didn't work for me.
<tt class="docutils literal">WriteHeader()</tt> method implemented by my <tt class="docutils literal">MyResponseWriter()</tt> was never called except for then there was a redirect. I expected that
the call to <tt class="docutils literal">Write()</tt> method of <tt class="docutils literal">http.ResponseWriter()</tt> would invoke the version of <tt class="docutils literal">WriterHeader()</tt> I implemented, but I cannot
see any way that could happen from the code in <tt class="docutils literal">net/http/server.go</tt>. So I think this is what's &quot;implied&quot; in this and all the other posts I have seen: the handler for the request must call <tt class="docutils literal">WriteHeader()</tt> with the HTTP status as the server code above does.</p>
<p>It looks like <a class="reference external" href="https://github.com/golang/go/issues/18997">soon</a> there will be a direct way to get the HTTP response status.</p>
</div>
<div class="section" id="references">
<h2>References</h2>
<p>The following links helped me understand the above and write this post:</p>
<ul class="simple">
<li><a class="reference external" href="http://jordanorelli.com/post/42369331748/function-types-in-go-golang">http://jordanorelli.com/post/42369331748/function-types-in-go-golang</a></li>
<li><a class="reference external" href="https://golang.org/doc/effective_go.html#interface_methods">https://golang.org/doc/effective_go.html#interface_methods</a></li>
<li><a class="reference external" href="https://gocodecloud.com/blog/2016/11/15/simple-golang-http-request-context-example/">https://gocodecloud.com/blog/2016/11/15/simple-golang-http-request-context-example/</a></li>
<li><a class="reference external" href="https://www.slideshare.net/blinkingsquirrel/customising-your-own-web-framework-in-go">https://www.slideshare.net/blinkingsquirrel/customising-your-own-web-framework-in-go</a></li>
</ul>
</div>

  </div>
  <div class="article_meta">
    <p>Posted on: Wed 26 April 2017</p>
    <p>Category: <a href="http://echorand.me/category/golang.html">golang</a>
    </p>
  </div>


</article>


    <div id="ending_message">
      <p>&copy; Amit Saha. Built using <a href="http://getpelican.com" target="_blank">Pelican</a>. Theme by Giulio Fidente on <a href="https://github.com/gfidente/pelican-svbhack" target="_blank">github</a>. </p>
    </div>
  </main>
</body>
</html>