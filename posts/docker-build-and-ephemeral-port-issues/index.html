<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> Ephemeral source port ranges and docker build | Exploring Software</title>
  <meta name="description" content="echo $RANDOM. Exploring Software and writing about it.">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="Ephemeral source port ranges and docker build" />
<meta property="og:description" content="TLDR; If you are having trouble with docker build and ephemeral port ranges, we can use iptables to solve the issue:
$ sudo iptables -t nat -I POSTROUTING -p tcp -m tcp --sport 32768:61000 -j MASQUERADE --to-ports 49152-61000 I have written previously about how things get interesting with ephemeral port ranges in a Windows and Linux environment and AWS network acls. Today’s post is related to the same topic but specifically relevant if you are building docker images in such an environment." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://echorand.me/posts/docker-build-and-ephemeral-port-issues/" />
<meta property="article:published_time" content="2019-01-14T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-08-19T13:40:05+10:00" />

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Ephemeral source port ranges and docker build"/>
<meta name="twitter:description" content="TLDR; If you are having trouble with docker build and ephemeral port ranges, we can use iptables to solve the issue:
$ sudo iptables -t nat -I POSTROUTING -p tcp -m tcp --sport 32768:61000 -j MASQUERADE --to-ports 49152-61000 I have written previously about how things get interesting with ephemeral port ranges in a Windows and Linux environment and AWS network acls. Today’s post is related to the same topic but specifically relevant if you are building docker images in such an environment."/>

  
  
  
  <link rel="stylesheet" href="https://echorand.me/css/style-white.css">
  
  
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://echorand.me/images/favicon.ico" />

  
  
  
  
  
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-108901610-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

  
  
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

  <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
        <li><a href="/about">About</a></li>
         
        <li><a href="/articles">Articles</a></li>
         
        <li><a href="/books">Books</a></li>
         
        <li><a href="/posts">Posts</a></li>
         
        <li><a href="/talks">Talks</a></li>
         
        <li><a href="/categories/">Categories</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li>
          <a class="icon" href=" https://echorand.me/posts/aws-codedeploy-autoscaling-group/">
            <i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i>
          </a>
        </li>
        
        
        <li>
          <a class="icon" href="https://echorand.me/posts/scheduled-task-docker-prune/">
            <i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i>
          </a>
        </li>
        
        <li>
          <a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');">
            <i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i>
          </a>
        </li>
        <li>
          <a class="icon" href="#">
            <i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i>
          </a>
        </li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fechorand.me%2fposts%2fdocker-build-and-ephemeral-port-issues%2f">
      <i class="fab fa-facebook " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fechorand.me%2fposts%2fdocker-build-and-ephemeral-port-issues%2f&text=Ephemeral%20source%20port%20ranges%20and%20docker%20build">
      <i class="fab fa-twitter " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fechorand.me%2fposts%2fdocker-build-and-ephemeral-port-issues%2f&title=Ephemeral%20source%20port%20ranges%20and%20docker%20build">
      <i class="fab fa-linkedin " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fechorand.me%2fposts%2fdocker-build-and-ephemeral-port-issues%2f&is_video=false&description=Ephemeral%20source%20port%20ranges%20and%20docker%20build">
      <i class="fab fa-pinterest " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=Ephemeral%20source%20port%20ranges%20and%20docker%20build&body=Check out this article: https%3a%2f%2fechorand.me%2fposts%2fdocker-build-and-ephemeral-port-issues%2f">
      <i class="fas fa-envelope " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fechorand.me%2fposts%2fdocker-build-and-ephemeral-port-issues%2f&title=Ephemeral%20source%20port%20ranges%20and%20docker%20build">
      <i class="fab fa-get-pocket " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fechorand.me%2fposts%2fdocker-build-and-ephemeral-port-issues%2f&title=Ephemeral%20source%20port%20ranges%20and%20docker%20build">
      <i class="fab fa-reddit " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2fechorand.me%2fposts%2fdocker-build-and-ephemeral-port-issues%2f&title=Ephemeral%20source%20port%20ranges%20and%20docker%20build">
      <i class="fab fa-stumbleupon " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://digg.com/submit?url=https%3a%2f%2fechorand.me%2fposts%2fdocker-build-and-ephemeral-port-issues%2f&title=Ephemeral%20source%20port%20ranges%20and%20docker%20build">
      <i class="fab fa-digg " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fechorand.me%2fposts%2fdocker-build-and-ephemeral-port-issues%2f&name=Ephemeral%20source%20port%20ranges%20and%20docker%20build&description=TLDR%3b%20If%20you%20are%20having%20trouble%20with%20docker%20build%20and%20ephemeral%20port%20ranges%2c%20we%20can%20use%20iptables%20to%20solve%20the%20issue%3a%0a%24%20sudo%20iptables%20-t%20nat%20-I%20POSTROUTING%20-p%20tcp%20-m%20tcp%20--sport%2032768%3a61000%20-j%20MASQUERADE%20--to-ports%2049152-61000%20I%20have%20written%20previously%20about%20how%20things%20get%20interesting%20with%20ephemeral%20port%20ranges%20in%20a%20Windows%20and%20Linux%20environment%20and%20AWS%20network%20acls.%20Today%e2%80%99s%20post%20is%20related%20to%20the%20same%20topic%20but%20specifically%20relevant%20if%20you%20are%20building%20docker%20images%20in%20such%20an%20environment.">
      <i class="fab fa-tumblr " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fechorand.me%2fposts%2fdocker-build-and-ephemeral-port-issues%2f&t=Ephemeral%20source%20port%20ranges%20and%20docker%20build">
      <i class="fab fa-hacker-news " aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>
    <div id="toc">
      <nav id="TableOfContents"></nav>
    </div>
  </span>
</div>


  <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <header>
      <h1 class="posttitle" itemprop="name headline">
        Ephemeral source port ranges and docker build
      </h1>
      <div class="meta">
        
        <div class="postdate">
          
          <time datetime="2019-01-14 00:00:00 &#43;0000 UTC" itemprop="datePublished">2019-01-14</time>
          
        </div>
        
        <div class="article-category">
            <i class="fas fa-archive"></i>
            
            
            <a class="category-link" href="/categories/infrastructure">infrastructure</a>
            
        </div>
        
        
      </div>
    </header>

  
    <div class="content" itemprop="articleBody">
      <p>TLDR; If you are having trouble with <code>docker build</code> and ephemeral port ranges, we can use <code>iptables</code> to solve the issue:</p>
<pre><code>$ sudo iptables -t nat -I POSTROUTING -p tcp -m tcp --sport 32768:61000 -j MASQUERADE --to-ports 49152-61000
</code></pre><p>I have written <a href="https://echorand.me/aws-network-acls-and-ephemeral-port-ranges.html">previously</a> about how things get interesting with ephemeral port ranges in a Windows and Linux environment and AWS network acls. Today’s post is related to the same topic but specifically relevant if you are building docker images in such an environment.</p>
<p>Let’s start with the Dockerfile:</p>
<pre><code># Build runtime image
FROM microsoft/dotnet:2.2-aspnetcore-runtime
RUN apt-get -y update
..
</code></pre><p>The instruction <code>RUN apt-get -y update</code>  will make network requests to download resources from the Internet over HTTP. This means it will select a certain source port to make these HTTP requests. However, in a controlled environment, we want to explicitly state the range of ephemeral ports that should be use, else these requests will not succeed.</p>
<p>Let&rsquo;s see how we can do that.</p>
<h1 id="background">Background</h1>
<p>How does a docker build happen? Inside containers. What do we do if we want to configure the ephemeral port range for these builder containers? We can’t seem to be able to run sysctl in this scenario. We could use <code>docker build --host</code> to share the host’s network namespace. And that will ensure that out host’s ephemeral port range will be used. However, we also had user namespacing turned on in our setup since this is a <a href="https://echorand.me/docker-userns-remap-and-system-users-on-linux.html">sensible</a> thing to do. However, we cannot use a user namespace while using the host network. So, what do we do?</p>
<h1 id="solution">Solution</h1>
<p>Could we have a iptables rule to perform a source port translation so that anything that is going out of our host always uses a source port from the specified port range? Generally speaking, we will need to perform a variation of Source NAT. However, we will only change the source port and leave the IP address alone. The following rule will do it:</p>
<pre><code>$ sudo iptables -t nat -I POSTROUTING -p tcp -m tcp --sport 32768:61000 -j MASQUERADE --to-ports 49152-61000
</code></pre><p>Here&rsquo;s what the above rule does:</p>
<ol>
<li>We are adding this rule to the <code>nat</code> table (<code>-t nat</code>) in the <code>POSTROUTING</code>(<code>-I POSTROUTING</code>) chain</li>
<li>We want this rule to be applied for <code>TCP</code> (<code>-p tcp</code>) packets which has a source port in the range 32768-61000 (<code>--sport 32768-61000</code>)</li>
<li>If a packet matches our rule, forward it to the <code>MASQUERADE</code> target (<code>-j MASQUERADE</code>)</li>
<li>Once in the <code>MASQUERADE</code> target, change the source port to be in the range 49152-61000 (<code>--to-ports 49152-61000</code>)</li>
</ol>
<p>The resultant <code>iptables-save</code> will look as follows:</p>
<pre><code># Generated by iptables-save v1.6.1 on Mon Jan 14 06:27:10 2019
*nat
:PREROUTING ACCEPT [80:4975]
:INPUT ACCEPT [2:136]
:OUTPUT ACCEPT [401:30352]
:POSTROUTING ACCEPT [298:24143]
:DOCKER - [0:0]
-A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER
-A OUTPUT ! -d 127.0.0.0/8 -m addrtype --dst-type LOCAL -j DOCKER
-A POSTROUTING -p tcp -m tcp --sport 32768:61000 -j MASQUERADE --to-ports 49152-61000
-A POSTROUTING -s 172.17.0.0/16 ! -o docker0 -j MASQUERADE
-A DOCKER -i docker0 -j RETURN
COMMIT
# Completed on Mon Jan 14 06:27:10 2019
</code></pre><p>This assumes you don&rsquo;t have any other iptables rules configured other than what docker engine configures and then our rule above.</p>
<h1 id="gotchas">Gotchas</h1>
<p>Okay, so where/when do you add this <code>iptables</code> rule? We have to add this <em>after</em> docker engine has started. <code>docker</code> creates
its own firewall rules which seems to be like &ldquo;drop everything else and add my own&rdquo;. So, here&rsquo;s how I am doing it in AWS EC2 user
data:</p>
<ol>
<li>EC2 instance initialization</li>
<li>docker daemon starts</li>
<li>Add iptables rule</li>
</ol>
<p>And a real code snippet:</p>
<pre><code>
# Add VPC DNS server as an additional DNS server
# https://github.com/amitsaha/aws-vpc-dns-address
vpc_dns=$(aws-vpc-dns-address)
echo '{&quot;dns&quot;:[&quot;'&quot;$vpc_dns&quot;'&quot;, &quot;8.8.8.8&quot;]}' &gt; /etc/docker/daemon.json
cat /etc/docker/daemon.json
systemctl restart docker

..
# This helps us workaround NACLs in place so that all traffic originating traffic source port is mapped to 
# the allowed ephemeral port range
# We carefully do it after we have restarted docker engine, since it inserts inserts
# its own iptables rules which flushes ours
iptables -t nat -I POSTROUTING -p tcp -m tcp --sport 32768:61000 -j MASQUERADE --to-ports 49152-61000
</code></pre><p>A more full proof appraoch would be to perhaps write a systemd unit file so that it will always run a program/script to insert
the above firewall rule when <code>docker</code> engine is started/restarted.</p>
<p>Know about a better idea? Please let me know.</p>
<h1 id="learn-more">Learn more</h1>
<p>There&rsquo;s much to learn about <a href="https://www.frozentux.net/iptables-tutorial/iptables-tutorial.html">iptables</a>. The most relevant
ones for this post to be familiar with are:</p>
<ul>
<li><a href="https://www.booleanworld.com/depth-guide-iptables-linux-firewall/#Chains">Chains</a></li>
<li><a href="https://www.frozentux.net/iptables-tutorial/chunkyhtml/x4422.html">Masquerade target</a></li>
<li><a href="https://www.frozentux.net/iptables-tutorial/iptables-tutorial.html#MATCHES">Iptables matches</a></li>
</ul>

    </div>
  </article>

  
  





  <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/about">About</a></li>
         
          <li><a href="/articles">Articles</a></li>
         
          <li><a href="/books">Books</a></li>
         
          <li><a href="/posts">Posts</a></li>
         
          <li><a href="/talks">Talks</a></li>
         
          <li><a href="/categories/">Categories</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <nav id="TableOfContents"></nav>
    </div>

    <div id="share-footer" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fechorand.me%2fposts%2fdocker-build-and-ephemeral-port-issues%2f">
      <i class="fab fa-facebook fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fechorand.me%2fposts%2fdocker-build-and-ephemeral-port-issues%2f&text=Ephemeral%20source%20port%20ranges%20and%20docker%20build">
      <i class="fab fa-twitter fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fechorand.me%2fposts%2fdocker-build-and-ephemeral-port-issues%2f&title=Ephemeral%20source%20port%20ranges%20and%20docker%20build">
      <i class="fab fa-linkedin fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fechorand.me%2fposts%2fdocker-build-and-ephemeral-port-issues%2f&is_video=false&description=Ephemeral%20source%20port%20ranges%20and%20docker%20build">
      <i class="fab fa-pinterest fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=Ephemeral%20source%20port%20ranges%20and%20docker%20build&body=Check out this article: https%3a%2f%2fechorand.me%2fposts%2fdocker-build-and-ephemeral-port-issues%2f">
      <i class="fas fa-envelope fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fechorand.me%2fposts%2fdocker-build-and-ephemeral-port-issues%2f&title=Ephemeral%20source%20port%20ranges%20and%20docker%20build">
      <i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fechorand.me%2fposts%2fdocker-build-and-ephemeral-port-issues%2f&title=Ephemeral%20source%20port%20ranges%20and%20docker%20build">
      <i class="fab fa-reddit fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2fechorand.me%2fposts%2fdocker-build-and-ephemeral-port-issues%2f&title=Ephemeral%20source%20port%20ranges%20and%20docker%20build">
      <i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://digg.com/submit?url=https%3a%2f%2fechorand.me%2fposts%2fdocker-build-and-ephemeral-port-issues%2f&title=Ephemeral%20source%20port%20ranges%20and%20docker%20build">
      <i class="fab fa-digg fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fechorand.me%2fposts%2fdocker-build-and-ephemeral-port-issues%2f&name=Ephemeral%20source%20port%20ranges%20and%20docker%20build&description=TLDR%3b%20If%20you%20are%20having%20trouble%20with%20docker%20build%20and%20ephemeral%20port%20ranges%2c%20we%20can%20use%20iptables%20to%20solve%20the%20issue%3a%0a%24%20sudo%20iptables%20-t%20nat%20-I%20POSTROUTING%20-p%20tcp%20-m%20tcp%20--sport%2032768%3a61000%20-j%20MASQUERADE%20--to-ports%2049152-61000%20I%20have%20written%20previously%20about%20how%20things%20get%20interesting%20with%20ephemeral%20port%20ranges%20in%20a%20Windows%20and%20Linux%20environment%20and%20AWS%20network%20acls.%20Today%e2%80%99s%20post%20is%20related%20to%20the%20same%20topic%20but%20specifically%20relevant%20if%20you%20are%20building%20docker%20images%20in%20such%20an%20environment.">
      <i class="fab fa-tumblr fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fechorand.me%2fposts%2fdocker-build-and-ephemeral-port-issues%2f&t=Ephemeral%20source%20port%20ranges%20and%20docker%20build">
      <i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>

    <div id="actions-footer">
      
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;">
          <i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;">
          <i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;">
          <i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');">
          <i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>


  <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2020  Exploring Software 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/about">About</a></li>
         
        <li><a href="/articles">Articles</a></li>
         
        <li><a href="/books">Books</a></li>
         
        <li><a href="/posts">Posts</a></li>
         
        <li><a href="/talks">Talks</a></li>
         
        <li><a href="/categories/">Categories</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>



</html>
