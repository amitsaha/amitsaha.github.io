<!DOCTYPE html>
<html><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="echo $RANDOM. Exploring Software and writing about it.">
    
    <link rel="shortcut icon" href="https://echorand.me/favicon.ico">
    
    <link rel="stylesheet" href="/css/style.min.css">

    <title>Kubernetes pod security policies</title>
</head>
<body><header id="banner">
    <h2><a href="https://echorand.me">Exploring Software</a></h2>
    <nav>
        <ul>
            <li>
                <a href="/about" title="">About</a>
            </li><li>
                <a href="/articles" title="">Articles</a>
            </li><li>
                <a href="/books" title="">Books</a>
            </li><li>
                <a href="/posts" title="">Posts</a>
            </li><li>
                <a href="/talks" title="">Talks</a>
            </li><li>
                <a href="/categories/" title="">Categories</a>
            </li>
        </ul>
    </nav>
</header>
<main id="content">
<article>
    <header id="post-header">
        <h1>Kubernetes pod security policies</h1><time>May 20, 2020</time></header><h1 id="introduction">Introduction</h1>
<p>Pod security policies are <a href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/">cluster level resources</a>.
The Google cloud <a href="https://cloud.google.com/kubernetes-engine/docs/how-to/pod-security-policies">docs</a> has some basic
human friendly docs.  A <code>psp</code> is a way to enforce certain policies that <code>pod</code> needs to comply with before it&rsquo;s allowed
to be scheduled to be run on the cluster - create or an update operation (perhaps a restart of the pod?). Essentially,
it is a type of a <a href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/">validating admission controller</a>.</p>
<p>I should mention that I found it (later on) to think about pod security policies as a way to &ldquo;control&rdquo; various
attributes of a pod. Hence, the <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.14/#podspec-v1-core">pod spec</a> is worth referring to simultaneously.</p>
<p>The  summarized version of how pod security policies are enforced in practice is:</p>
<ul>
<li>Cluster admin creates a policy (<code>psp</code>)</li>
<li>Cluster admin creates a cluster role allowing usage of the policy</li>
<li>CLuster admin creates a cluster role binding assigning subjects to the above role and hence allow usage of the policy</li>
</ul>
<p>On an AWS <a href="https://docs.aws.amazon.com/eks/latest/userguide/pod-security-policy.html">EKS cluster</a>, we can see there
is an existing policy already defined:</p>
<pre><code>$ kubectl describe psp
Name:  eks.privileged

Settings:
  Allow Privileged:                       true
  Allow Privilege Escalation:             true
  Default Add Capabilities:               &lt;none&gt;
  Required Drop Capabilities:             &lt;none&gt;
  Allowed Capabilities:                   *
  Allowed Volume Types:                   *
  Allow Host Network:                     true
  Allow Host Ports:                       0-65535
  Allow Host PID:                         true
  Allow Host IPC:                         true
  Read Only Root Filesystem:              false
  SELinux Context Strategy: RunAsAny      
    User:                                 &lt;none&gt;
    Role:                                 &lt;none&gt;
    Type:                                 &lt;none&gt;
    Level:                                &lt;none&gt;
  Run As User Strategy: RunAsAny          
    Ranges:                               &lt;none&gt;
  FSGroup Strategy: RunAsAny              
    Ranges:                               &lt;none&gt;
  Supplemental Groups Strategy: RunAsAny  
    Ranges:                               &lt;none&gt;

</code></pre><p>The granular permissions are documented <a href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/#policy-reference">here</a>, but the above policy essentially allows pods to be created with all the permissions available.</p>
<p>We also have an associated cluster role binding:</p>
<pre><code>$ kubectl describe clusterrolebinding eks:podsecuritypolicy:authenticated 
Name:         eks:podsecuritypolicy:authenticated
Labels:       eks.amazonaws.com/component=pod-security-policy
              kubernetes.io/cluster-service=true
Annotations:  kubectl.kubernetes.io/last-applied-configuration:
                {&quot;apiVersion&quot;:&quot;rbac.authorization.k8s.io/v1&quot;,&quot;kind&quot;:&quot;ClusterRoleBinding&quot;,&quot;metadata&quot;:{&quot;annotations&quot;:{&quot;kubernetes.io/description&quot;:&quot;Allow all...
              kubernetes.io/description: Allow all authenticated users to create privileged pods.
Role:
  Kind:  ClusterRole
  Name:  eks:podsecuritypolicy:privileged
Subjects:
  Kind   Name                  Namespace
  ----   ----                  ---------
  Group  system:authenticated  

</code></pre><p>The details are documented in the EKS documentation above, but essentially the above role binding allows all
authenticated users (group: <code>system:authenticated</code>) to make use of the above policy - or, any authenticated user
is allowed to run privileged pods with <em>no</em> policy enforced. Now, if we see which policy <em>any</em> pod is running with, it
will show that it is using the <code>eks.privileged</code> policy:</p>
<pre><code>$ kubectl -n &lt;my-ns&gt; get pod xledger-api-79c745d7d7-ng2j2  -o jsonpath='{.metadata.annotations.kubernetes\.io\/psp}'
eks.privileged
</code></pre><p>Now, the reason we have the default pod security policy and the binding is that there <em>must</em> be a pod security policy
that is defined in your cluster to allow a pod to be scheduled for running if you have the admission controller
enabled. If there was no default policy, no pod would be &ldquo;admitted&rdquo; by the cluster.</p>
<h1 id="enforcing-policies">Enforcing policies</h1>
<p>So, let&rsquo;s say we want to make things better. One way to do would be to define workload specific policies and a
default restricted policy. The workload specific policies would have certain privileged access, but not all
and they would be explicitly granted via making use of service accounts. The default would however be the
restricted policy. Let&rsquo;s first look at the restricted policy which will apply to all authenticated &ldquo;users&rdquo;:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">policy/v1beta1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PodSecurityPolicy</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">default</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">privileged</span>: <span style="color:#66d9ef">false</span>
  <span style="color:#75715e"># Required to prevent escalations to root.</span>
  <span style="color:#f92672">allowPrivilegeEscalation</span>: <span style="color:#66d9ef">false</span>
  <span style="color:#75715e"># This is redundant with non-root + disallow privilege escalation,</span>
  <span style="color:#75715e"># but we can provide it for defense in depth.</span>
  <span style="color:#f92672">requiredDropCapabilities</span>:
    - <span style="color:#ae81ff">ALL</span>
  <span style="color:#75715e"># Allow core volume types.</span>
  <span style="color:#f92672">volumes</span>:
    - <span style="color:#e6db74">&#39;configMap&#39;</span>
    - <span style="color:#e6db74">&#39;emptyDir&#39;</span>
    - <span style="color:#e6db74">&#39;projected&#39;</span>
    - <span style="color:#e6db74">&#39;secret&#39;</span>
    <span style="color:#75715e"># Assume that persistentVolumes set up by the cluster admin are safe to use.</span>
    - <span style="color:#e6db74">&#39;persistentVolumeClaim&#39;</span>
  <span style="color:#f92672">hostNetwork</span>: <span style="color:#66d9ef">false</span>
  <span style="color:#f92672">hostIPC</span>: <span style="color:#66d9ef">false</span>
  <span style="color:#f92672">hostPID</span>: <span style="color:#66d9ef">false</span>
  <span style="color:#f92672">runAsUser</span>:
    <span style="color:#f92672">rule</span>: <span style="color:#e6db74">&#39;MustRunAsNonRoot&#39;</span>
  <span style="color:#f92672">seLinux</span>:
    <span style="color:#75715e"># This policy assumes the nodes are using AppArmor rather than SELinux.</span>
    <span style="color:#f92672">rule</span>: <span style="color:#e6db74">&#39;RunAsAny&#39;</span>
  <span style="color:#f92672">supplementalGroups</span>:
    <span style="color:#f92672">rule</span>: <span style="color:#e6db74">&#39;MustRunAs&#39;</span>
    <span style="color:#f92672">ranges</span>:
      <span style="color:#75715e"># Forbid adding the root group.</span>
      - <span style="color:#f92672">min</span>: <span style="color:#ae81ff">1</span>
        <span style="color:#f92672">max</span>: <span style="color:#ae81ff">65535</span>
  <span style="color:#f92672">fsGroup</span>:
    <span style="color:#f92672">rule</span>: <span style="color:#e6db74">&#39;MustRunAs&#39;</span>
    <span style="color:#f92672">ranges</span>:
      <span style="color:#75715e"># Forbid adding the root group.</span>
      - <span style="color:#f92672">min</span>: <span style="color:#ae81ff">1</span>
        <span style="color:#f92672">max</span>: <span style="color:#ae81ff">65535</span>
  <span style="color:#f92672">readOnlyRootFilesystem</span>: <span style="color:#66d9ef">false</span>
</code></pre></div><p>To come up with the workload specific policies, we need to first figure out what kind of privileged access we need
to allow them to have.  We will need to make sure that the custom policies we enforce account for
the permissions that these pods need. <a href="https://github.com/sysdiglabs/kube-psp-advisor">kube-psp-advisor</a> is an useful
tool that helps us here. The <code>inspect</code> sub-command can examine your cluster and generate pod security policies
as well as grants for those policies. Thus a starting point would be to examine each namespace of your cluster
where you have workloads and run:</p>
<pre><code>$ kubectl-advise-psp inspect --grant -n &lt;your namespace&gt;
</code></pre><p>Once you have got all the policies you have for all the workloads, you will quickly see that for each workload,
we will create a:</p>
<ul>
<li>Pod Security Policy</li>
<li>Cluster Role</li>
<li>Cluster Role Binding</li>
</ul>
<p>Hence, to minimize duplication, we can make use of <a href="https://kustomize.io/">kustomize</a>.</p>
<h1 id="using-kustomize-to-manage-policies">Using <code>kustomize</code> to manage policies</h1>
<p>We can use <code>kustomize</code> base and overlays in the following manner to manage the various policies:</p>
<pre><code>.
├── base
│   ├── kustomization.yaml
│   ├── kustomizeconfig.yaml
│   ├── psp.yaml
│   ├── rolebinding.yaml
│   └── role.yaml
├── overlays
│   ├── aws-node
│   ├── calico-node
│   ├── calico-typha-autoscaler
│   ├── coredns
│   ├── fluent-bit
│   ├── ingress-controllers
│   ├── restricted

..
</code></pre><p>Let&rsquo;s look at the <code>base/psp.yaml</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">policy/v1beta1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PodSecurityPolicy</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">default</span>
  <span style="color:#f92672">annotations</span>:
    <span style="color:#f92672">seccomp.security.alpha.kubernetes.io/allowedProfileNames</span>: <span style="color:#e6db74">&#39;docker/default,runtime/default&#39;</span>
    <span style="color:#f92672">seccomp.security.alpha.kubernetes.io/defaultProfileName</span>:  <span style="color:#e6db74">&#39;runtime/default&#39;</span>
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">kubernetes.io/cluster-service</span>: <span style="color:#e6db74">&#34;true&#34;</span>

</code></pre></div><p>We don&rsquo;t define any policy at all here, but just define the <code>PodSecurityPolicy</code> resource.</p>
<p>Let&rsquo;s look at <code>base/role.yaml</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">
<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">psp-default</span>
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">kubernetes.io/cluster-service</span>: <span style="color:#e6db74">&#34;true&#34;</span>
    <span style="color:#f92672">eks.amazonaws.com/component</span>: <span style="color:#ae81ff">pod-security-policy</span>
<span style="color:#f92672">rules</span>:
- <span style="color:#f92672">apiGroups</span>:
  - <span style="color:#ae81ff">policy</span>
  <span style="color:#f92672">resourceNames</span>:
  - <span style="color:#ae81ff">default</span>
  <span style="color:#f92672">resources</span>:
  - <span style="color:#ae81ff">podsecuritypolicies</span>
  <span style="color:#f92672">verbs</span>:
  - <span style="color:#ae81ff">use</span>

</code></pre></div><p>The above <code>ClusterRole</code> allows using the <code>default</code> pod security policy.</p>
<p>Tying the above <code>role</code> and <code>psp</code> resources is the <code>ClusterRoleBinding</code> as follows in <code>base/rolebinding.yaml</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRoleBinding</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">psp-default</span>
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">kubernetes.io/cluster-service</span>: <span style="color:#e6db74">&#34;true&#34;</span>
<span style="color:#f92672">roleRef</span>:
  <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">psp-default</span>

</code></pre></div><p>The cluster role binding above doesn&rsquo;t specify any subjects.</p>
<p>Before we look at the overlays, let&rsquo;s look at the <code>kustomization.yaml</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">resources</span>:
- <span style="color:#ae81ff">psp.yaml</span>
- <span style="color:#ae81ff">role.yaml</span>
- <span style="color:#ae81ff">rolebinding.yaml</span>
<span style="color:#f92672">configurations</span>:
- <span style="color:#ae81ff">kustomizeconfig.yaml</span>
</code></pre></div><p>The interesting bit here for our purpose is the <code>kustomizeconfig.yaml</code> file:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">nameReference</span>:
- <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PodSecurityPolicy</span>
  <span style="color:#f92672">fieldSpecs</span>:  
  - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">rules/resourceNames</span>
    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
</code></pre></div><p><code>nameReference</code> transformer which I originally learned about from this
<a href="https://github.com/kubernetes-sigs/kustomize/issues/1646">issue</a> allows us to use the name of a resource in another
resource. If you look at the base configuration above, you may have been thinking how do we refer to the pod
security policy (<code>kind: PodSecurityPolicy</code>) we generated in a overlay in the cluster role (<code>kind: ClusterRole</code>) for
the overlay. <code>nameReference</code> allows us to do just that. In plain terms, the above <code>nameReference</code> transformer
essentially substitutes reference to <code>rules/resourceNames</code> in <code>ClusterRole</code> to the name of <code>PodSecurityPolicy</code>
generated in that specific overlay.</p>
<p>The result is that an overlay directory looks like this:</p>
<pre><code>restricted
├── kustomization.yaml
└── restricted.yaml

</code></pre><p>The <code>kustomization.yaml</code> file has the following contents:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">kustomize.config.k8s.io/v1beta1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Kustomization</span>
<span style="color:#f92672">bases</span>:
- <span style="color:#ae81ff">../../base</span>
<span style="color:#f92672">namePrefix</span>: <span style="color:#ae81ff">restricted-</span>
<span style="color:#f92672">patches</span>:
- <span style="color:#ae81ff">restricted.yaml</span>
</code></pre></div><p>The <code>namePrefix</code> here is used to somewhat indicate the specific workload we are generating the policy for.</p>
<p>The <code>restricted.yaml</code> file defines the overlay for the <code>PodSecurityPolicy</code> and the <code>ClusterRoleBinding</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">policy/v1beta1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PodSecurityPolicy</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">default</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">privileged</span>: <span style="color:#66d9ef">false</span>
  <span style="color:#75715e"># Required to prevent escalations to root.</span>
  <span style="color:#f92672">allowPrivilegeEscalation</span>: <span style="color:#66d9ef">false</span>
  <span style="color:#75715e"># This is redundant with non-root + disallow privilege escalation,</span>
  <span style="color:#75715e"># but we can provide it for defense in depth.</span>
  <span style="color:#f92672">requiredDropCapabilities</span>:
    - <span style="color:#ae81ff">ALL</span>
  <span style="color:#75715e"># Allow core volume types.</span>
  <span style="color:#f92672">volumes</span>:
    - <span style="color:#e6db74">&#39;configMap&#39;</span>
    - <span style="color:#e6db74">&#39;emptyDir&#39;</span>
    - <span style="color:#e6db74">&#39;projected&#39;</span>
    - <span style="color:#e6db74">&#39;secret&#39;</span>
    <span style="color:#75715e"># Assume that persistentVolumes set up by the cluster admin are safe to use.</span>
    - <span style="color:#e6db74">&#39;persistentVolumeClaim&#39;</span>
  <span style="color:#f92672">hostNetwork</span>: <span style="color:#66d9ef">false</span>
  <span style="color:#f92672">hostIPC</span>: <span style="color:#66d9ef">false</span>
  <span style="color:#f92672">hostPID</span>: <span style="color:#66d9ef">false</span>
  <span style="color:#f92672">runAsUser</span>:
    <span style="color:#f92672">rule</span>: <span style="color:#e6db74">&#39;MustRunAsNonRoot&#39;</span>
  <span style="color:#f92672">seLinux</span>:
    <span style="color:#75715e"># This policy assumes the nodes are using AppArmor rather than SELinux.</span>
    <span style="color:#f92672">rule</span>: <span style="color:#e6db74">&#39;RunAsAny&#39;</span>
  <span style="color:#f92672">supplementalGroups</span>:
    <span style="color:#f92672">rule</span>: <span style="color:#e6db74">&#39;MustRunAs&#39;</span>
    <span style="color:#f92672">ranges</span>:
      <span style="color:#75715e"># Forbid adding the root group.</span>
      - <span style="color:#f92672">min</span>: <span style="color:#ae81ff">1</span>
        <span style="color:#f92672">max</span>: <span style="color:#ae81ff">65535</span>
  <span style="color:#f92672">fsGroup</span>:
    <span style="color:#f92672">rule</span>: <span style="color:#e6db74">&#39;MustRunAs&#39;</span>
    <span style="color:#f92672">ranges</span>:
      <span style="color:#75715e"># Forbid adding the root group.</span>
      - <span style="color:#f92672">min</span>: <span style="color:#ae81ff">1</span>
        <span style="color:#f92672">max</span>: <span style="color:#ae81ff">65535</span>
  <span style="color:#f92672">readOnlyRootFilesystem</span>: <span style="color:#66d9ef">false</span>
---
<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRoleBinding</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">psp-default</span>
<span style="color:#f92672">subjects</span>:
  - <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Group</span>
    <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">system:authenticated</span>
</code></pre></div><p>Note that we don&rsquo;t need to define the <code>ClusterRole</code> in the overlay at all. If we look at the <code>ClusterRole</code> definition
in the <code>base/role.yaml</code> file above, we will see that it only needs reference to the <code>PodSecurityPolicy</code> name that
will be generated. The <code>nameReference</code> transformer takes care of that.</p>
<p>With the above overlay, when we run <code>kustomize build</code>, we get the following:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">policy/v1beta1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">PodSecurityPolicy</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">annotations</span>:
    <span style="color:#f92672">seccomp.security.alpha.kubernetes.io/allowedProfileNames</span>: <span style="color:#ae81ff">docker/default,runtime/default</span>
    <span style="color:#f92672">seccomp.security.alpha.kubernetes.io/defaultProfileName</span>: <span style="color:#ae81ff">runtime/default</span>
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">kubernetes.io/cluster-service</span>: <span style="color:#e6db74">&#34;true&#34;</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">restricted-default</span>
<span style="color:#f92672">spec</span>:
  <span style="color:#f92672">allowPrivilegeEscalation</span>: <span style="color:#66d9ef">false</span>
  <span style="color:#f92672">fsGroup</span>:
    <span style="color:#f92672">ranges</span>:
    - <span style="color:#f92672">max</span>: <span style="color:#ae81ff">65535</span>
      <span style="color:#f92672">min</span>: <span style="color:#ae81ff">1</span>
    <span style="color:#f92672">rule</span>: <span style="color:#ae81ff">MustRunAs</span>
  <span style="color:#f92672">hostIPC</span>: <span style="color:#66d9ef">false</span>
  <span style="color:#f92672">hostNetwork</span>: <span style="color:#66d9ef">false</span>
  <span style="color:#f92672">hostPID</span>: <span style="color:#66d9ef">false</span>
  <span style="color:#f92672">privileged</span>: <span style="color:#66d9ef">false</span>
  <span style="color:#f92672">readOnlyRootFilesystem</span>: <span style="color:#66d9ef">false</span>
  <span style="color:#f92672">requiredDropCapabilities</span>:
  - <span style="color:#ae81ff">ALL</span>
  <span style="color:#f92672">runAsUser</span>:
    <span style="color:#f92672">rule</span>: <span style="color:#ae81ff">MustRunAsNonRoot</span>
  <span style="color:#f92672">seLinux</span>:
    <span style="color:#f92672">rule</span>: <span style="color:#ae81ff">RunAsAny</span>
  <span style="color:#f92672">supplementalGroups</span>:
    <span style="color:#f92672">ranges</span>:
    - <span style="color:#f92672">max</span>: <span style="color:#ae81ff">65535</span>
      <span style="color:#f92672">min</span>: <span style="color:#ae81ff">1</span>
    <span style="color:#f92672">rule</span>: <span style="color:#ae81ff">MustRunAs</span>
  <span style="color:#f92672">volumes</span>:
  - <span style="color:#ae81ff">configMap</span>
  - <span style="color:#ae81ff">emptyDir</span>
  - <span style="color:#ae81ff">projected</span>
  - <span style="color:#ae81ff">secret</span>
  - <span style="color:#ae81ff">persistentVolumeClaim</span>
---
<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">eks.amazonaws.com/component</span>: <span style="color:#ae81ff">pod-security-policy</span>
    <span style="color:#f92672">kubernetes.io/cluster-service</span>: <span style="color:#e6db74">&#34;true&#34;</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">restricted-psp-default</span>
<span style="color:#f92672">rules</span>:
- <span style="color:#f92672">apiGroups</span>:
  - <span style="color:#ae81ff">policy</span>
  <span style="color:#f92672">resourceNames</span>:
  - <span style="color:#ae81ff">restricted-default</span>
  <span style="color:#f92672">resources</span>:
  - <span style="color:#ae81ff">podsecuritypolicies</span>
  <span style="color:#f92672">verbs</span>:
  - <span style="color:#ae81ff">use</span>
---
<span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io/v1</span>
<span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRoleBinding</span>
<span style="color:#f92672">metadata</span>:
  <span style="color:#f92672">labels</span>:
    <span style="color:#f92672">kubernetes.io/cluster-service</span>: <span style="color:#e6db74">&#34;true&#34;</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">restricted-psp-default</span>
<span style="color:#f92672">roleRef</span>:
  <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterRole</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">restricted-psp-default</span>
<span style="color:#f92672">subjects</span>:
- <span style="color:#f92672">apiGroup</span>: <span style="color:#ae81ff">rbac.authorization.k8s.io</span>
  <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Group</span>
  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">system:authenticated</span>
</code></pre></div><h1 id="rolling-the-policy-changes-out">Rolling the policy changes out</h1>
<p>Once we have written our policies and applied them to the cluster, they will not affect any of the currently running
workloads unless any of the pods has been killed and hence restarted, etc.</p>
<p>Hence, to &ldquo;switch over&rdquo; the current workloads to use the policies we created, we will need to do the following:</p>
<ul>
<li>Remove the existing default <code>ClusterRoleBinding</code></li>
<li>Restart the existing workloads - <code>kubectl rollout restart</code> really helps here</li>
</ul>
<p>This step is prone to cause interruptions if the policy has not been set correctly or there are multiple
matching policies (see next). Hence, exercise caution. In my experience <code>kube-psp-advisor</code> really helped here.</p>
<h1 id="multiple-matching-policies">Multiple matching policies</h1>
<p>To summarize how a pod creation operation and pod security policies admission controller interacts:</p>
<ol>
<li>Pod creation request is received</li>
<li>An attempt is made to find a matching policy for the pod</li>
<li>If a matching policy is found, is this policy allowed to be used by the pod is checked</li>
<li>If the above check passes, the pod is &ldquo;admitted&rdquo;, else &ldquo;rejected&rdquo;.</li>
</ol>
<p>Now, what happens if we have multiple matching policies in step 2? The kubernetes <a href="https://v1-14.docs.kubernetes.io/docs/concepts/policy/pod-security-policy/#policy-order">documentation</a> on this topic has changed
between <a href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/">releases</a> , but illustrates
another aspect of pod security policy - mutating and non-mutating. We have established that each pod <em>has</em> to
have a  pod security policy enabled. Now, the pod security policy that matches  a pod doesn&rsquo;t need to specify all
the various fields. In that scenario, the fields not specified will be attached to the pod with their default values.
Thus, this is a &ldquo;mutating&rdquo; pod security policy. However, if the policy specified all fields, this would be attached as
is to the pod and hence be a &ldquo;non-mutating&rdquo; pod security policy.</p>
<p>For kubernetes 1.14, this is what the documentation says will happen when there are multiple matching policies:</p>
<ol>
<li>If any policies successfully validate the pod without altering it, they are used.</li>
<li>If it is a pod creation request, then the first valid policy in alphabetical order is used.</li>
<li>Otherwise, if it is a pod update request, an error is returned, because pod mutations are
disallowed during update operation</li>
</ol>
<p>(1) above is really confusing and hence it has been fixed in the docs for a <a href="https://github.com/kubernetes/website/commit/7f90c73a01664c42746b734b1911143c884741bb#diff-a5873cb014f885fa40ee16cfdccddd30">while</a> and is currently this:</p>
<ol>
<li>PodSecurityPolicies which allow the pod as-is, without changing defaults or mutating the pod, are preferred.
The order of these non-mutating PodSecurityPolicies doesn’t matter.</li>
<li>If the pod must be defaulted or mutated, the first PodSecurityPolicy (ordered by name) to allow the pod is selected.</li>
</ol>
<p>Note: During update operations (during which mutations to pod specs are disallowed) only non-mutating PodSecurityPolicies are
used to validate the pod.</p>
<p>The logic is implemented in the Kubernetes source code
<a href="https://github.com/kubernetes/kubernetes/blob/323f34858de18b862d43c40b2cced65ad8e24052/plugin/pkg/admission/security/podsecuritypolicy/admission.go#L209">here</a></p>
<p>I would like to add one more point to the above which matches the source code which is - even if there is a mutating
pod security policy, it will prefer a non-mutating policy if it exists. This is still subject to the permission
check which happens after a matching policy is found.</p>
<h1 id="conclusion">Conclusion</h1>
<p>Pod Security policies are a great way to enforce compliance on your workloads as a cluster admin. Some links to resources
which I made use of while working on this are:</p>
<ul>
<li><a href="https://kubernetes.io/docs/concepts/policy/pod-security-policy/#policy-order">Kubernetes documentation</a></li>
<li><a href="https://docs.aws.amazon.com/eks/latest/userguide/pod-security-policy.html">EKS documentation on the topic</a></li>
<li><a href="https://github.com/sysdiglabs/kube-psp-advisor">kube-psp-advisor</a></li>
<li><a href="https://gist.github.com/amitsaha/581c2abafc8bcf71849a74e4d2683792">Basic Go program to list all pods and their pod security policies</a></li>
</ul>
</article>

        </main><footer id="footer">
    
    Post last updated: {"hash":"838493464090a0d04f18408d278f92c834f51403","abbreviatedHash":"8384934","subject":"Update kubernetes-pod-security-policies.md","authorName":"Amit Saha","authorEmail":"amitsaha@users.noreply.github.com","authorDate":"2020-05-20T15:55:09+10:00","commitDate":"2020-05-20T15:55:09+10:00"}.
</footer>
</body>
</html>
